(tbl as table) as table =>
let
    Fonte = Table.Buffer(tbl),

    // Cria coluna CHAVE LOG a partir da concatenação
    AddChaveLog = Table.AddColumn(
        Fonte,
        "CHAVE LOG",
        each Text.Trim(
            Text.Combine(
                List.Transform(
                    {[ESTACAO_ABASTECEDORA],[LOCALIDADE],[LOGRADOURO],[COMPLEMENTO],[COMPLEMENTO2]},
                    each if _ = null then "" else Text.Trim(_)
                ),
                "-"
            ),
            "-"
        ),
        type text
    ),

    // Reordena para colocar CHAVE LOG como primeira coluna
    Reordena = Table.ReorderColumns(AddChaveLog, {"CHAVE LOG"} & List.RemoveItems(Table.ColumnNames(AddChaveLog), {"CHAVE LOG"})),

    // Normaliza o texto
    AjusteTexto = Table.TransformColumns(Reordena, {
        {"COMPLEMENTO3", each if _ = null then "" else Text.Upper(Text.Trim(_)), type text}
    }),

    // Extrai prefixo
    AdicionaPrefixo =
        Table.AddColumn(
            AjusteTexto,
            "Prefixo",
            each try Text.Start([COMPLEMENTO3], 2) otherwise null,
            type text
        ),

    // Remove prefixos inválidos
    FiltraPrefixo =
        Table.SelectRows(
            AdicionaPrefixo,
            each [Prefixo] <> null and [Prefixo] <> ""
        ),

    // Agrupa por CHAVE LOG e Prefixo para criar numeração
    Agrupado =
        Table.Group(
            FiltraPrefixo,
            {"CHAVE LOG", "Prefixo"},
            {{"Todas", each Table.AddIndexColumn(_, "Ordem", 1, 1, Int64.Type), type table}}
        ),

    // Descobre as colunas originais sem duplicar chave
    ColunasParaExpandir = List.Difference(Table.ColumnNames(FiltraPrefixo), {"CHAVE LOG","Prefixo"}),

    // Expande sem duplicar CHAVE LOG
    Expande =
        Table.ExpandTableColumn(
            Agrupado,
            "Todas",
            ColunasParaExpandir & {"Ordem"}
        ),

    // Junta prefixo + número
    AdicionaResultado =
        Table.AddColumn(
            Expande,
            "Resultado",
            each [Prefixo] & " " & Text.From([Ordem]),
            type text
        ),

    // Remove colunas auxiliares
    RemoveCols = Table.RemoveColumns(AdicionaResultado, {"Prefixo"})
in
    RemoveCols
